blueprint:
  name: AI Smart Camera Notification System
  description: >
    ### üì¢ Ch·ª•p ·∫£nh, Ph√¢n t√≠ch ·∫£nh b·∫±ng AI v√† g·ª≠i Th√¥ng b√°o l√™n ƒëi·ªán tho·∫°i, zalo, telegram, Discord v√† ra loa n·∫øu C·∫£m bi·∫øn k√≠ch ho·∫°t v√† th·ª±c t·∫ø c√≥ ng∆∞·ªùi xu·∫•t hi·ªán trong ·∫£nh.

    <details>
    <summary><b>Chi ti·∫øt:</b> - Nh·∫•n ƒë·ªÉ m·ªü r·ªông</summary>

      **Phi√™n b·∫£n: v.2025.10.22**

        - Chuy·ªÉn sang d√πng AI-Task

        - B·ªè l∆∞u ·∫£nh v√†o th∆∞ m·ª•c `www` ch·ªâ l∆∞u v√†o `Media`

      ***Tham kh·∫£o link d∆∞·ªõi ƒë·ªÉ th√™m code v√†o trong configuration.yaml***

        - https://www.home-assistant.io/integrations/media_source/
        

      **T√°c gi·∫£: Khaisilk1910 - Nguy·ªÖn Ti·∫øn Kh·∫£i**

        1- **C√°c c·∫£m bi·∫øn d√πng trong Blueprints: `Motion`(Chuy·ªÉn ƒë·ªông), `Presences`(Hi·ªán di·ªán), `Door`(C·ª≠a)**

        2- **Th√¥ng b√°o ph√¢n t√≠ch h√¨nh ·∫£nh b·∫±ng AI l√™n ·ª©ng d·ª•ng Home Assistant, Zalo, Telegram, Discord v√† TTS ra Loa ƒë∆∞·ª£c t√≠ch h·ª£p v√†o Home Assistant üí¨üîâ**
        
        3- **Actions Settings: N·∫øu g·ª≠i th√¥ng b√°o l√™n Hass s·∫Ω c√≥ th√™m t√πy ch·ªçn Actions tr√™n th√¥ng b√°o ƒë·ªÉ th·ª±c hi·ªán Actions ngay tr√™n th√¥ng b√°o Hass.**
        
        4- **Ch·ªâ th√¥ng b√°o khi ph√°t hi·ªán `C√≥ Ng∆∞·ªùi` trong ·∫£nh**: do s·ª≠ d·ª•ng AI ph√¢n t√≠ch v√† k·∫øt h·ª£p ƒëi·ªÅu ki·ªán ƒë·ªÉ lo·∫°i b·ªè th√¥ng b√°o ·∫£o t·ª´ sensor khi th·ª±c t·∫ø kh√¥ng c√≥ ng∆∞·ªùi trong khung h√¨nh.

        5- **C√≥ th·ªÉ t√πy ch·ªçn g·ª≠i th√¥ng b√°o l√™n nhi·ªÅu ƒêi·ªán tho·∫°i, Telegram v√† l√™n nhi·ªÅu Loa ƒë∆∞·ª£c t√≠nh h·ª£p trong Home Assistant.**
        
        6- **C√≥ th·ªÉ th√™m nhi·ªÅu H√†nh ƒë·ªông t√πy ch·ªçn n·∫øu mu·ªën th·ª±c hi·ªán.**
        
        7- **C√≥ th·ªÉ th√™m nhi·ªÅu ƒêi·ªÅu ki·ªán ƒë·ªÉ ch·∫°y Automation**
    </details>      

  domain: automation
  input:

    motion_sensor:
      name: Trigger sensor
      description: Ch·ªçn c·∫£m bi·∫øn ƒë·ªÉ k√≠ch ho·∫°t ch·ª•p ·∫£nh.
      selector:
        entity:
          domain: binary_sensor
          device_class:
            - motion
            - occupancy
            - door

    camera_device:
      name: Camera
      description: Camera m√† b·∫°n mu·ªën ch·ª•p ·∫£nh
      selector:
        entity:
          domain: camera

    ai_powered:
      name: AI-powered (Optional)
      description: >
        S·ª≠ d·ª•ng AI ƒë·ªÉ ph√¢n t√≠ch ·∫£nh v√† ƒë∆∞a n·ªôi dung ph√¢n t√≠ch ·∫£nh v√†o th√¥ng b√°o.
        <br/>N·∫øu s·ª≠ d·ª•ng AI ph√¢n t√≠ch s·∫Ω b·ªã tr·ªÖ th√¥ng b√°o v√†i gi√¢y so v·ªõi ·∫£nh ch·ª•p. V√¨ ph·∫£i ch·ªù th·ªùi gian AI ph√¢n t√≠ch ·∫£nh xem c√≥ ng∆∞·ªùi m·ªõi g·ª≠i th√¥ng b√°o.
        <br/>N·∫øu kh√¥ng s·ª≠ d·ª•ng AI s·∫Ω hay b·ªã g·ª≠i th√¥ng b√°o ·∫£o khi kh√¥ng c√≥ ng∆∞·ªùi trong ·∫£nh do sensor ph√°t hi·ªán nh·∫ßm c√≥ chuy·ªÉn ƒë·ªông do m√¥i tr∆∞·ªùng, ƒë·ªông v·∫≠t.
      default: enable_actions_ai_powered_notify
      selector:
        select:
          options:
            - label: Enable AI-powered Options
              value: "enable_actions_ai_powered_notify"
            - label: Disable AI-powered Options
              value: "disable_actions_ai_powered_notify"

    ai_provider:
      name: Provider of AI
      description: >
        Ch·ªçn AI s·ªß d·ª•ng cho vi·ªác ph√¢n t√≠ch ·∫£nh.
        N·∫øu kh√¥ng B·∫≠t s·ª≠ d·ª•ng AI b√™n tr√™n kh√¥ng c·∫ßn ch·ªçn
      selector:
        entity:
          domain: ai_task
      default: []

    record_video:
      name: Recording (Optional)
      description: >
        T√πy ch·ªçn ghi video ƒë·ªÉ g·ª≠i khi c√≥ ph√°t hi·ªán chuy·ªÉn ƒë·ªông.
        <br/>M·∫∑c ƒë·ªãnh ghi video 10s. V√¨ v·∫≠y th√¥ng b√°o video s·∫Ω tr·ªÖ h∆°n.
        <br/>G·ª≠i video l√™n c√°c n·ªÅn t·∫£ng nh·∫Øn tin Zalo, Telegram, Discord.
      default: disable_recording_options
      selector:
        select:
          options:
            - label: Enable Recording Options
              value: "enable_recording_options"
            - label: Disable Recording Options
              value: "disable_recording_options"

    device_notify_settings:
      name: "Mobile App Notify"
      icon: mdi:devices
      collapsed: true
      input:
        include_notify:
          name: Use The Mobile App Notify Option (Optional)
          description: >
            Enable n·∫øu mu·ªën g·ª≠i th√¥ng b√°o l√™n ƒëi·ªán tho·∫°i ƒë√£ ch·ªçn b√™n d∆∞·ªõi. Xem th√™m t·∫°i https://companion.home-assistant.io/docs/notifications/notifications-basic
          default: disable_mobile_app_notify
          selector:
            select:
              options:
                - label: Enable Mobile App Notify Options
                  value: "enable_mobile_app_notify"
                - label: Disable Mobile App Notify Options
                  value: "disable_mobile_app_notify"

        is_ios_android:
          name: Is it an Android or iOS device?
          description: >
            Ch·ªçn ƒëi·ªán tho·∫°i ƒë·∫©y th√¥ng b√°o l√† Android hay iOS?
          default: android_device
          selector:
            select:
              options:
                - label: Android
                  value: "android_device"
                - label: iOS
                  value: "ios_device"
        notify_device:
          name: Devices Notified
          description: >
            Ch·ªçn ƒêi·ªán tho·∫°i mu·ªën th√¥ng b·∫£o ƒë·∫©y l√™n.
          default: []
          selector:
            device:
              filter:
                - integration: mobile_app
              multiple: true
        notify_title:
          name: Title
          description: >
            Nh·∫≠p Title c·ªßa Th√¥ng b√°o.
            <br/>C√≥ th·∫ª d√πng CSS HTML ƒë·ªÉ thi·∫øt l·∫≠p m√†u s·∫Øc, In ƒë·∫≠m,... cho n·ªôi dung
          default: >
            üì¢ <b><span style="color: red">{{camera_name}}</span></b><i> c√≥ chuy·ªÉn ƒë·ªông</i>
          selector:
            text:
        tap_navigate:
          name: Tap Navigate
          description: >
            M·ªü Home Assistant v√† ƒëi ƒë·∫øn v·ªã tr√≠ b√™n d∆∞·ªõi khi Th√¥ng b√°o ƒë∆∞·ª£c m·ªü.(V√≠ d·ª•: /lovelace/cameras).
          default: /lovelace/camera
          selector:
            text:
              multiline: false
              multiple: false
        status_bar_icon:
          name: "üå† Status Bar Icon"
          description: >
            `D√†nh cho` `Android`
            Thi·∫øt l·∫≠p icon cho th√¥ng b√°o tr√™n Status Bar ƒëi·ªán tho·∫°i
            T√¨m icon t·∫°i https://pictogrammers.com/library/mdi/
          default: mdi:motion-sensor
          selector:
            icon:
              placeholder: mdi:motion-sensor
        notification_color:
          name: "üé® Notification Color"
          description: >
            `D√†nh cho` `Android`
            Thi·∫øt l·∫≠p m√†u cho icon th√¥ng b√°o tr√™n Status Bar ƒëi·ªán tho·∫°i
          default: [255, 0, 0]
          selector:
            color_rgb:

    actions_settings:
      name: "Actions Settings"
      icon: mdi:gesture-double-tap
      collapsed: true
      input:
        include_actions:
          name: Use Actions For Mobile App Notify Option (Optional)
          description: >
            Enable n·∫øu mu·ªën c√≥ Actions trong th√¥ng b√°o l√™n ƒëi·ªán tho·∫°i ƒë√£ ch·ªçn.<br/>Xem th√™m t·∫°i https://companion.home-assistant.io/docs/notifications/actionable-notifications
          default: disable_actions_mobile_app_notify
          selector:
            select:
              options:
                - label: Enable Actions Options
                  value: "enable_actions_mobile_app_notify"
                - label: Disable Actions Options
                  value: "disable_actions_mobile_app_notify"
        confirm_text:
          name: "Confirmation Text"
          description: "Text to show on the confirmation button"
          default: "‚úÖ Confirm"
          selector:
            text:
        confirm_action:
          name: "Confirmation Action"
          description: "Action to run when notification is confirmed"
          default: []
          selector:
            action:
        dismiss_text:
          name: "Dismiss Text"
          description: "Text to show on the dismiss button"
          default: "‚ùå Dismiss"
          selector:
            text:
        enable_custom_dismiss_action:
          name: "Enable Custom Dismiss Action"
          description: "Display notification on Android Auto interface."
          default: false
          selector:
            boolean: {}
        custom_dismiss_action:
          name: "Custom Dismiss Action"
          description: "Action to run when notification is dismissed"
          default: []
          selector:
            action:
        tag:
          name: "\U0001F516‚ÄÉTag"
          description: "Used to uniquely identify the notification.  \n\nUse tag if you
            are using this script with other notification services.  \nLeave empty otherwise.
            \ \n\nExample: `my_awesome_notification_for_device_X`  \n\n\U0001F44D\U0001F3FB‚ÄÉRecommended
            to leave empty\n\n`Optional`"
          default: "dimiss_notifications_now"
          selector:
            text: {}
        timeout:
          name: ‚åõÔ∏è‚ÄÉTimeout Duration
          description: "Amount of time to wait for an action response before firing timeout action.  \n\n\U0001F44D\U0001F3FB‚ÄÉRecommended: ‚â•1 minute, to allow notifications to be sent.  \nDefault: 10 minutes. \n"
          default:
            hours: 0
            minutes: 10
            seconds: 0
          selector:
            duration:
              enable_day: false


    zalo_settings:
      name: "Zalo Notifications Settings"
      icon: mdi:message-image-outline
      collapsed: true
      input:
        include_zalo_notify:
          name: Use Zalo Notifications Option (Optional)
          description: >
            Enable n·∫øu mu·ªën g·ª≠i th√¥ng b√°o l√™n Zalo.<br/>Xem th√™m t·∫°i https://github.com/smarthomeblack/zalo_bot
          default: disable_zalo_notification
          selector:
            select:
              options:
                - label: Enable Zalo Notifications
                  value: "enable_zalo_notification"
                - label: Disable Zalo Notifications
                  value: "disable_zalo_notification"

        zalo_group_id:
          name: Zalo Group ID
          description: ID c·ªßa user ho·∫∑c nh√≥m Zalo (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng).
          selector:
            text:
          default: ""

        zalo_phone:
          name: Zalo Acc
          description: S·ªë ƒëi·ªán tho·∫°i c·ªßa Zalo Bot (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng).
          selector:
            text:
          default: "+84000000000"

        zalo_types:
          name: Use Zalo Type Option (Optional)
          description: >
            Ch·ªçn th√¥ng b√°o l√™n Zalo c√° nh√¢n ho·∫∑c group.<br/>Xem th√™m t·∫°i https://github.com/smarthomeblack/zalo_bot
          default: "0"
          selector:
            select:
              options:
                - label: User
                  value: "0"
                - label: Group
                  value: "1"
        zalo_ttl:
          name: TTL
          description: Th·ªùi gian ch·ªù sau th·ªùi gian n√†y tin nh·∫Øn s·∫Ω t·ª± x√≥a.
          selector:
            number:
              min: 0
              max: 86400000
              step: 1000
              unit_of_measurement: seconds
          default: 0
        
        zalo_video:
          name: Send Video (Optional)
          description: T√πy ch·ªçn c√≥ g·ª≠i video l√™n Zalo kh√¥ng?
          default: true
          selector:
            boolean: {}

    telegram_settings:
      name: "Telegram Notifications Settings"
      icon: mdi:message-badge
      collapsed: true
      input:
        include_telegram_notify:
          name: Use Telegram Notifications Option (Optional)
          description: >
            Enable n·∫øu mu·ªën g·ª≠i th√¥ng b√°o l√™n Telegram.<br/>Xem th√™m t·∫°i https://www.home-assistant.io/integrations/?search=telegram
          default: disable_telegram_notification
          selector:
            select:
              options:
                - label: Enable Telegram Notifications
                  value: "enable_telegram_notification"
                - label: Disable Telegram Notifications
                  value: "disable_telegram_notification"
     
        provider:
          name: Config entry ID
          description: Choose Telegram Bot to use for send Notifications.
          selector:
            config_entry:
              integration: telegram_bot
          default: []

        telegram_group_id:
          name: Telegram Group ID
          description: ID c·ªßa nh√≥m Telegram (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng).
          selector:
            text:
          default: ""

        telegram_topic:
          name: Telegram Topic ID
          description: ID c·ªßa ch·ªß ƒë·ªÅ trong nh√≥m Telegram (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng).
          selector:
            text:
          default: ""
       
        tele_video:
          name: Send Video (Optional)
          description: T√πy ch·ªçn c√≥ g·ª≠i video l√™n Telegram kh√¥ng?
          default: true
          selector:
            boolean: {}
            
    discord_settings:
      name: "Discord Notifications Settings"
      icon: mdi:message-bulleted
      collapsed: true
      input:
        include_discord_notify:
          name: Use Discord Notifications Option (Optional)
          description: >
            Enable n·∫øu mu·ªën g·ª≠i th√¥ng b√°o l√™n Discord.<br/>Xem th√™m t·∫°i https://www.home-assistant.io/integrations/discord/
          default: disable_discord_notification
          selector:
            select:
              options:
                - label: Enable Discord Notifications
                  value: "enable_discord_notification"
                - label: Disable Discord Notifications
                  value: "disable_discord_notification"
        discord_channel:
          name: Discord Channel ID
          description: ID c·ªßa Channel trong nh√≥m Discord (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng d√πng).
          selector:
            text:
          default: ""
       
        discord_video:
          name: Send Video (Optional)
          description: T√πy ch·ªçn c√≥ g·ª≠i video l√™n Discord kh√¥ng?
          default: true
          selector:
            boolean: {}

    tts_notify_settings:
      name: "Speakers Settings"
      icon: mdi:speaker-message
      collapsed: true
      input:
        include_tts_announcement:
          name: Use The Text-to-Speech Announcement Option (Optional)
          description: >
            Enable khi mu·ªën g·ª≠i TTS ra loa s·∫Ω ch·ªçn b√™n d∆∞·ªõi.<br/>Xem th√™m t·∫°i https://www.home-assistant.io/integrations/?search=tts
          default: disable_tts_announcement
          selector:
            select:
              options:
                - label: Enable Text-to-Speech Announcements
                  value: "enable_tts_announcement"
                - label: Disable Text-to-Speech Announcements
                  value: "disable_tts_announcement"
        num_volume_speaker:
          name: Volume Set
          description: Thi·∫øt l·∫≠p √Çm l∆∞·ª£ng cho Loa. ( t·ª´ 0.1 ƒë·∫øn 1)
          selector:
            number:
              min: 0.1
              max: 1
              step: 0.1
              #unit_of_measurement: snapshots
          default: 1
        text_to_speech_engine:
          name: Text-to-Speech Service Provider
          description: >
            Ch·ªçn d·ªãch v·ª• TTS h·ªó tr·ª£.
          default: []
          selector:
            entity:
              filter:
                domain: tts
        media_player:
          name: Media Player
          description: >
            Ch·ªçn loa ƒë·ªÉ ph√°t th√¥ng b√°o
          default: []
          selector:
            entity:
              filter:
                domain: media_player
              multiple: true

    prompt_number_delay_settings:
      name: "Prompt | Number | Delay of Snapshots"
      icon: mdi:clock-start
      collapsed: true
      input:
        num_snapshots:
          name: Number of Snapshots
          description: S·ªë ·∫£nh s·∫Ω ch·ª•p ƒë·ªÉ so s√°nh (t·ª´ 1 ƒë·∫øn 5)
          selector:
            number:
              min: 1
              max: 5
              step: 1
              unit_of_measurement: snapshots
          default: 1
        num_delay:
          name: Delay after Snapshots
          description: Th·ªùi gian tr·ªÖ sau m·ªói l·∫ßn Snapshots (t√≠nh theo gi√¢y)
          selector:
            number:
              min: 1
              max: 60
              step: 1
              unit_of_measurement: seconds
          default: 1
        num_delay_actions:
          name: Delays
          description: Th·ªùi gian ch·ªù sau khi ho√†n th√†nh t·∫•t c·∫£ c√°c h√†nh ƒë·ªông (t√≠nh theo gi√¢y).<br/>Automation n√†y ch·ªâ ho·∫°t ƒë·ªông l·∫°i sau khi h·∫øt th·ªùi gian Delay n√†y.
          selector:
            number:
              min: 5
              max: 120
              step: 5
              unit_of_measurement: seconds
          default: 5

        ai_prompt:
          name: AI Prompt
          description: C√¢u l·ªánh cho AI ph√¢n t√≠ch.
          selector:
            text:
              multiline: true
          default: >
            D√πng ng√¥n ng·ªØ Vi·ªát Nam. H√£y so s√°nh v√† m√¥ t·∫£ r·∫•t ng·∫Øn g·ªçn nh·ªØng g√¨ b·∫°n th·∫•y trong chu·ªói h√¨nh ·∫£nh sau t·ª´ m√°y ·∫£nh {{ camera_name }} c·ªßa t√¥i. N·∫øu c√≥ ng∆∞·ªùi, ƒë·ªông v·∫≠t, xe m√°y ho·∫∑c √¥ t√¥, h√£y m√¥ t·∫£ chi ti·∫øt v·ªÅ ch√∫ng. Ch·ªâ r√µ gi·ªõi t√≠nh, ng∆∞·ªùi l·ªõn hay tr·∫ª em. Kh√¥ng m√¥ t·∫£ c√°c v·∫≠t th·ªÉ ho·∫∑c t√≤a nh√† c·ªë ƒë·ªãnh. N·∫øu trong chu·ªói ·∫£nh kh√¥ng c√≥ ng∆∞·ªùi h√£y tr·∫£ l·ªùi "ƒê√£ ph√°t hi·ªán chuy·ªÉn ƒë·ªông tuy nhi√™n kh√¥ng c√≥ ng∆∞·ªùi trong chu·ªói ·∫£nh khi so s√°nh". Tin nh·∫Øn c·ªßa b·∫°n c·∫ßn ƒë·ªß ng·∫Øn ƒë·ªÉ c√≥ th·ªÉ ƒë∆∞a v√†o th√¥ng b√°o tr√™n ƒëi·ªán tho·∫°i.

    custom_actions_settings:
      name: "Custom Actions"
      icon: mdi:gesture-tap-button
      collapsed: true
      input:
        include_custom_actions:
          name: Use The Custom Action Options (Optional)
          description: >
            Ch·ªçn Enable Custom Actions v√† th√™m Actions b√™n d∆∞·ªõi n·∫øu b·∫°n mu·ªën th√™m c√°c H√†nh ƒë·ªông kh√°c ƒë·ªÉ th·ª±c hi·ªán trong Automation n√†y.
          default: disable_custom_actions
          selector:
            select:
              options:
                - label: Enable Custom Actions
                  value: "enable_custom_actions"
                - label: Disable Custom Actions
                  value: "disable_custom_actions"
        custom_actions:
          name: Custom Actions
          description: >
            Th√™m b·∫•t k·ª≥ h√†nh ƒë·ªông n√†o b·∫°n mu·ªën ch·∫°y trong Automation n√†y.
            <br/>Bi·∫øn l·∫•y n·ªôi dung ph√¢n t√≠ch AI cho c√°c n·ªôi dung kh√°c: `humans_detected_report.data.humans_detected_description`
          default: []
          selector:
            action:

    global_conditions_settings:
      name: "Global Conditions"
      icon: mdi:earth
      collapsed: true
      input:
        global_conditions:
          name: Add Condition(s) to run this Automation
          description: >
            Th√™m Condition ƒë·ªÉ ch·∫°y Automation.<br/>Automation ch·ªâ ch·∫°y khi Conditions n√†y l√† True.
          default: []
          selector:
            condition:

trigger:
  platform: state
  entity_id: !input motion_sensor
  to: "on"

variables:
  record_video: !input record_video
  #AI
  ai_powered: !input ai_powered
  ai_provider: !input ai_provider
  #Device Notify
  include_notify: !input include_notify
  notify_device: !input notify_device
  notify_title: !input notify_title
  tap_navigate: !input tap_navigate
  filtered_devices: >
    {{ notify_device }}
  is_ios_android: !input "is_ios_android"
  #Actions Settings
  include_actions: !input include_actions
  confirm_text: !input confirm_text
  dismiss_text: !input dismiss_text
  timeout: !input timeout
  enable_custom_dismiss_action: !input enable_custom_dismiss_action
  tag: !input tag
  #Zalo Message
  zalo_video: !input zalo_video
  include_zalo_notify: !input include_zalo_notify
  #Camera
  camera_device: !input camera_device
  camera_name: "{{ state_attr(camera_device, 'friendly_name') }}"
  camera_path: "{{ state_attr(camera_device, 'friendly_name') | slugify }}"
  #camera_path: "{{ state_attr(camera_device, 'friendly_name') | lower | replace(' ', '_') }}"
  #Motion Sensor
  motion_sensor: !input motion_sensor
  motion_name: "{{ state_attr(motion_sensor, 'friendly_name') }}"
  #Snapshot
  num_delay_actions: !input num_delay_actions
  num_snapshots: !input num_snapshots
  num_delay: !input num_delay
  #AI
  ai_prompt: !input ai_prompt
  #Telegram Message
  include_telegram_notify: !input include_telegram_notify
  provider: !input provider
  telegram_group_id: !input telegram_group_id
  telegram_topic: !input telegram_topic
  tele_video: !input tele_video
  #Discord
  include_discord_notify: !input include_discord_notify
  discord_channel: !input discord_channel
  discord_video: !input discord_video
  #TTS Message
  include_tts_announcement: !input include_tts_announcement
  num_volume_speaker: !input num_volume_speaker
  text_to_speech_engine: !input text_to_speech_engine
  media_player: !input media_player
  #Custom Actions
  include_custom_actions: !input include_custom_actions
  custom_actions: !input custom_actions
  #Global Conditions
  global_conditions: !input global_conditions

# All Conditions
condition:
  # Global Conditions
  - condition: and
    conditions: !input global_conditions

action:
  - variables:
      action_confirm: "{{ 'CONFIRM_' ~ context.id }}"
      action_dismiss: "{{ 'DISMISS_' ~ context.id }}"
      snapshot_access_file_path: "/media/local/snapshots/{{camera_path}}_snapshot1.jpg"
      snapshot_access_file_path_tele: "/media/snapshots/{{camera_path}}_snapshot1.jpg"
      snapshot_access_file_path_discord: "/media/snapshots/{{camera_path}}_snapshot1.jpg"
      notification_color: !input "notification_color"
      notification_color_hex: "#{{ '%02x%02x%02x' | format(notification_color[0], notification_color[1], notification_color[2]) }}"


  - alias: "Ch·∫°y c√πng l√∫c t·∫•t c·∫£ c√°c action"
    parallel:

      - alias: "Ch·∫°y l·∫ßn l∆∞·ª£t c√°c action"
        sequence:
          - repeat:
              count: "{{ num_snapshots }}"
              sequence:
                - action: camera.snapshot
                  data:
                    filename: "/media/snapshots/{{ camera_path }}_snapshot{{ repeat.index }}.jpg"
                  target:
                    entity_id: "{{ camera_device }}"
                - delay:
                    seconds: "{{ num_delay }}"

          - variables:
              snapshots_url: >
                {% set snap_count = num_snapshots | int %}
                {% set camera = camera_path %}
                {% set ns = namespace(images=[]) %}
                {%- for i in range(1, snap_count + 1) -%}
                  {% set ns.images = ns.images + [{'media_content_id': 'media-source://media_source/local/snapshots/' ~ camera ~ '_snapshot' ~ i ~ '.jpg', 'media_content_type': 'image/jpeg'}] %}
                {%- endfor -%}
                {{ ns.images }}

          - choose:
              - alias: "Check if notification is enabled"
                conditions:
                  - "{{ ai_powered == 'enable_actions_ai_powered_notify' }}"
                sequence:
                  - action: ai_task.generate_data
                    data:
                      task_name: Phan tich anh khi co chuyen dong
                      instructions: >
                        ƒê√¢y l√† chu·ªói h√¨nh ·∫£nh t·ª´ m√°y ·∫£nh {{camera_name}} c·ªßa t√¥i. C√≥ bao nhi√™u ng∆∞·ªùi trong chu·ªói ·∫£nh c·ªßa t√¥i?
                      entity_id: "{{ ai_provider }}"
                      attachments: "{{ snapshots_url }}"
                      structure:
                        humans_detected:
                          required: true
                          selector:
                            number: null
                        humans_detected_description:
                          description: "{{ ai_prompt }}"
                          required: true
                          selector:
                            text: null
                    response_variable: humans_detected_report

                  - variables:
                      ai_messages: >
                        ü§ñ{{camera_name}}{{'\n'}}üëâ {{ humans_detected_report.data.humans_detected_description }}{{'\n'}}üïí {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}

                  - if:
                      - condition: template
                        value_template: >
                          {{ not ( (humans_detected_report.data.humans_detected_description | default(''))| lower | regex_search('tuy nhi√™n kh√¥ng c√≥ ng∆∞·ªùi trong chu·ªói ·∫£nh|kh√¥ng c√≥ ng∆∞·ªùi|kh√¥ng c√≥ chu·ªói h√¨nh ·∫£nh n√†o ƒë∆∞·ª£c cung c·∫•p') and (humans_detected_report.data.humans_detected|int(0) == 0) ) }}
                    then:
                      - alias: "Ch·∫°y c√πng l√∫c t·∫•t c·∫£ c√°c Action"
                        parallel:
                          - choose:
                              - alias: "Check if notification is enabled"
                                conditions:
                                  - "{{ include_notify == 'enable_mobile_app_notify' }}"
                                  - "{{ filtered_devices | length > 0 }}"
                                sequence:
                                  - if:
                                      - condition: template
                                        value_template: "{{ include_actions == 'enable_actions_mobile_app_notify' }}"
                                    then:
                                      - choose:
                                          - alias: "Check if Android"
                                            conditions:
                                              - "{{ is_ios_android == 'android_device' }}"
                                            sequence:
                                              - alias: Send a notification to each device
                                                repeat:
                                                  for_each: "{{ filtered_devices }}"
                                                  sequence:
                                                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                      data:
                                                        title: !input notify_title
                                                        message: "{{ ai_messages }}"
                                                        data:
                                                          priority: high
                                                          notification_icon: !input status_bar_icon
                                                          color: "{{ notification_color_hex }}"
                                                          image: "{{snapshot_access_file_path}}"
                                                          url: "{{tap_navigate}}"
                                                          clickAction: "{{tap_navigate}}"
                                                          tag: "{{ tag }}"
                                                          actions:
                                                            - action: "{{ action_confirm }}"
                                                              title: "{{ confirm_text }}"
                                                            - action: "{{ action_dismiss }}"
                                                              title: "{{ dismiss_text }}"
                                          - alias: "Check if iOS"
                                            conditions:
                                              - "{{ is_ios_android == 'ios_device' }}"
                                            sequence:
                                              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                data:
                                                  title: !input notify_title
                                                  message: >
                                                    {{ ai_messages }}
                                                  data:
                                                    attachment:
                                                      url: "{{snapshot_access_file_path}}"
                                                      content_type: "JPEG"
                                                    tag: "{{ tag }}"
                                                    actions:
                                                      - action: "{{ action_confirm }}"
                                                        title: "{{ confirm_text }}"
                                                      - action: "{{ action_dismiss }}"
                                                        title: "{{ dismiss_text }}"
                                      - alias: "Awaiting response"
                                        wait_for_trigger:
                                          - platform: event
                                            event_type: mobile_app_notification_action
                                            event_data:
                                              action: "{{ action_confirm }}"
                                          - platform: event
                                            event_type: mobile_app_notification_action
                                            event_data:
                                              action: "{{ action_dismiss }}"
                                        timeout: '{{ timeout }}'
                                        continue_on_timeout: true
                                      - choose:
                                          - conditions: "{{ wait.trigger.event.data.action == action_confirm }}"
                                            sequence: !input confirm_action
                                          - conditions: "{{ wait.trigger.event.data.action == action_dismiss }}"
                                            sequence:
                                              - alias: N·∫øu Enable Custom Dismiss Action ƒë∆∞·ª£c B·∫≠t th√¨ s·∫Ω h√†nh ƒë·ªông theo Custom Dismiss Action. C√≤n kh√¥ng th√¨ s·∫Ω x√≥a Th√¥ng b√°o.
                                                if:
                                                  - condition: template
                                                    value_template: "{{ not enable_custom_dismiss_action}}"
                                                then:
                                                  - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                    data:
                                                      message: "clear_notification"
                                                      data:
                                                        tag: "{{ tag }}"
                                                else: !input custom_dismiss_action
                                    else:
                                      - choose:
                                          - alias: "Check if Android"
                                            conditions:
                                              - "{{ is_ios_android == 'android_device' }}"
                                            sequence:
                                              - alias: Send a notification to each device
                                                repeat:
                                                  for_each: "{{ filtered_devices }}"
                                                  sequence:
                                                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                      data:
                                                        title: !input notify_title
                                                        message: "{{ ai_messages }}"
                                                        data:
                                                          priority: high
                                                          notification_icon: !input status_bar_icon
                                                          color: "{{ notification_color_hex }}"
                                                          image: "{{snapshot_access_file_path}}"
                                                          url: "{{tap_navigate}}"
                                                          clickAction: "{{tap_navigate}}"
                                          - alias: "Check if iOS"
                                            conditions:
                                              - "{{ is_ios_android == 'ios_device' }}"
                                            sequence:
                                              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                data:
                                                  title: !input notify_title
                                                  message: >
                                                    {{ ai_messages }}
                                                  data:
                                                    attachment:
                                                      url: "{{snapshot_access_file_path}}"
                                                      content_type: "JPEG"

                          - if:
                              - condition: template
                                value_template: "{{ include_zalo_notify == 'enable_zalo_notification' }}"
                            then:
                              - action: zalo_bot.send_image
                                metadata: {}
                                data:
                                  type: !input zalo_types
                                  image_path: "{{ snapshot_access_file_path_tele }}"
                                  message: >
                                    {{ ai_messages }}
                                  thread_id: !input zalo_group_id
                                  account_selection: !input zalo_phone
                                  ttl: !input zalo_ttl

                          - if:
                              - condition: template
                                value_template: "{{ include_telegram_notify == 'enable_telegram_notification' }}"
                            then:
                              - action: telegram_bot.send_photo
                                data:
                                  config_entry_id: "{{ provider }}"
                                  authentication: digest
                                  target: "{{ telegram_group_id }}"
                                  message_thread_id: "{{ telegram_topic | int(0) }}"
                                  file: "{{ snapshot_access_file_path_tele }}"
                                  caption: >
                                    {{ ai_messages }}

                          - if:
                              - condition: template
                                value_template: "{{ include_discord_notify == 'enable_discord_notification' }}"
                            then:
                              - action: notify.hass_discord
                                metadata: {}
                                data:
                                  target: "{{discord_channel | int(0)}}"
                                  data:
                                    images:
                                      - "{{snapshot_access_file_path_discord}}"
                                  title: "{{camera_name}}"
                                  message: >
                                    {{ ai_messages }}

                          - if:
                              - condition: template
                                value_template: "{{ include_tts_announcement == 'enable_tts_announcement' }}"
                            then:
                              - action: media_player.volume_set
                                metadata: {}
                                data:
                                  volume_level: "{{num_volume_speaker}}"
                                target:
                                  entity_id: !input media_player
                              - action: tts.speak
                                target:
                                  entity_id: !input text_to_speech_engine
                                data:
                                  media_player_entity_id: !input media_player
                                  message: "{{humans_detected_report.data.humans_detected_description}}"

              - alias: "Check if AI is disable"
                conditions:
                  - "{{ ai_powered == 'disable_actions_ai_powered_notify' }}"
                sequence:
                  - variables:
                      ai_disable_messages_hass: >
                        üîç Ki·ªÉm tra ngay{{'\n'}}üïí {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                      ai_disable_messages_app: >
                        üîç Ph√°t hi·ªán chuy·ªÉn ƒë·ªông t·∫°i {{camera_name}}{{'\n'}}üïí {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                  - alias: "Ch·∫°y c√πng l√∫c t·∫•t c·∫£ c√°c Choose"
                    parallel:
                      - choose:
                          - alias: "Check if notification is enabled"
                            conditions:
                              - "{{ include_notify == 'enable_mobile_app_notify' }}"
                              - "{{ filtered_devices | length > 0 }}"
                            sequence:
                              - if:
                                  - condition: template
                                    value_template: "{{ include_actions == 'enable_actions_mobile_app_notify' }}"
                                then:
                                  - choose:
                                      - alias: "Check if Android"
                                        conditions:
                                          - "{{ is_ios_android == 'android_device' }}"
                                        sequence:
                                          - alias: Send a notification to each device
                                            repeat:
                                              for_each: "{{ filtered_devices }}"
                                              sequence:
                                                - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                  data:
                                                    title: !input notify_title
                                                    message: "{{ ai_disable_messages_hass }}"
                                                    data:
                                                      priority: high
                                                      notification_icon: !input status_bar_icon
                                                      color: "{{ notification_color_hex }}"
                                                      image: "{{snapshot_access_file_path}}"
                                                      url: "{{tap_navigate}}"
                                                      clickAction: "{{tap_navigate}}"
                                                      tag: "{{ tag }}"
                                                      actions:
                                                        - action: "{{ action_confirm }}"
                                                          title: "{{ confirm_text }}"
                                                        - action: "{{ action_dismiss }}"
                                                          title: "{{ dismiss_text }}"
                                      - alias: "Check if iOS"
                                        conditions:
                                          - "{{ is_ios_android == 'ios_device' }}"
                                        sequence:
                                          - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                            data:
                                              title: !input notify_title
                                              message:  "{{ ai_disable_messages_hass }}"
                                              data:
                                                attachment:
                                                  url: "{{snapshot_access_file_path}}"
                                                  content_type: "JPEG"
                                                tag: "{{ tag }}"
                                                actions:
                                                  - action: "{{ action_confirm }}"
                                                    title: "{{ confirm_text }}"
                                                  - action: "{{ action_dismiss }}"
                                                    title: "{{ dismiss_text }}"
                                  - alias: "Awaiting response"
                                    wait_for_trigger:
                                      - platform: event
                                        event_type: mobile_app_notification_action
                                        event_data:
                                          action: "{{ action_confirm }}"
                                      - platform: event
                                        event_type: mobile_app_notification_action
                                        event_data:
                                          action: "{{ action_dismiss }}"
                                    timeout: '{{ timeout }}'
                                    continue_on_timeout: true
                                  - choose:
                                      - conditions: "{{ wait.trigger.event.data.action == action_confirm }}"
                                        sequence: !input confirm_action
                                      - conditions: "{{ wait.trigger.event.data.action == action_dismiss }}"
                                        sequence:
                                          - alias: N·∫øu Enable Custom Dismiss Action ƒë∆∞·ª£c B·∫≠t th√¨ s·∫Ω h√†nh ƒë·ªông theo Custom Dismiss Action. C√≤n kh√¥ng th√¨ s·∫Ω x√≥a Th√¥ng b√°o.
                                            if:
                                              - condition: template
                                                value_template: "{{ not enable_custom_dismiss_action}}"
                                            then:
                                              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                data:
                                                  message: "clear_notification"
                                                  data:
                                                    tag: "{{ tag }}"
                                            else: !input custom_dismiss_action
                                else:
                                  - choose:
                                      - alias: "Check if Android"
                                        conditions:
                                          - "{{ is_ios_android == 'android_device' }}"
                                        sequence:
                                          - alias: Send a notification to each device
                                            repeat:
                                              for_each: "{{ filtered_devices }}"
                                              sequence:
                                                - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                  data:
                                                    title: !input notify_title
                                                    message:  "{{ ai_disable_messages_hass }}"
                                                    data:
                                                      priority: high
                                                      notification_icon: !input status_bar_icon
                                                      color: "{{ notification_color_hex }}"
                                                      image: "{{snapshot_access_file_path}}"
                                                      url: "{{tap_navigate}}"
                                                      clickAction: "{{tap_navigate}}"
                                      - alias: "Check if iOS"
                                        conditions:
                                          - "{{ is_ios_android == 'ios_device' }}"
                                        sequence:
                                          - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                            data:
                                              title: !input notify_title
                                              message:  "{{ ai_disable_messages_hass }}"
                                              data:
                                                attachment:
                                                  url: "{{snapshot_access_file_path}}"
                                                  content_type: "JPEG"

                      - if:
                          - condition: template
                            value_template: "{{ include_zalo_notify == 'enable_zalo_notification' }}"
                        then:
                          - action: zalo_bot.send_image
                            metadata: {}
                            data:
                              type: !input zalo_types
                              image_path: "{{ snapshot_access_file_path_tele }}"
                              message: "{{ ai_disable_messages_app }}"
                              thread_id: !input zalo_group_id
                              account_selection: !input zalo_phone
                              ttl: !input zalo_ttl

                      - if:
                          - condition: template
                            value_template: "{{ include_telegram_notify == 'enable_telegram_notification' }}"
                        then:
                          - action: telegram_bot.send_photo
                            data:
                              config_entry_id: "{{ provider }}"
                              authentication: digest
                              target: "{{ telegram_group_id }}"
                              message_thread_id: "{{ telegram_topic | int(0) }}"
                              file: "{{ snapshot_access_file_path_tele }}"
                              caption: "{{ ai_disable_messages_app }}"

                      - if:
                          - condition: template
                            value_template: "{{ include_discord_notify == 'enable_discord_notification' }}"
                        then:
                          - action: notify.hass_discord
                            metadata: {}
                            data:
                              target: "{{discord_channel | int(0)}}"
                              data:
                                images:
                                  - "{{snapshot_access_file_path_discord}}"
                              title: "{{camera_name}}"
                              message: "{{ ai_disable_messages_app }}"


      - if:
          - condition: template
            value_template: "{{ record_video == 'enable_recording_options' }}"
        then:
          - alias: "Ch·∫°y l·∫ßn l∆∞·ª£t c√°c action"
            sequence:
              - action: camera.record
                metadata: {}
                data:
                  duration: 8
                  lookback: 3
                  filename: /media/snapshots/{{ camera_path }}_recording.mp4
                target:
                  entity_id: "{{ camera_device }}"
              - variables:
                  snapshots_url_record: >
                    {% set camera = camera_path %}
                    {% set ns = [{'media_content_id': 'media-source://media_source/local/snapshots/' ~ camera ~ '_snapshot1.jpg', 'media_content_type': 'image/jpeg'}] %}
                    {{ ns }}
              - delay:
                  hours: 0
                  minutes: 0
                  seconds: 2
                  milliseconds: 0
              - choose:
                  - alias: "Check if AI is enabled"
                    conditions:
                      - "{{ ai_powered == 'enable_actions_ai_powered_notify' }}"
                    sequence:
                      - action: ai_task.generate_data
                        data:
                          task_name: Phan tich anh khi co chuyen dong
                          instructions: >
                            ƒê√¢y l√† h√¨nh ·∫£nh t·ª´ {{camera_name}} c·ªßa t√¥i. C√≥ bao nhi√™u ng∆∞·ªùi trong ·∫£nh c·ªßa t√¥i?
                          entity_id: "{{ ai_provider }}"
                          attachments: "{{ snapshots_url_record }}"
                          structure:
                            humans_detected:
                              required: true
                              selector:
                                number: null
                            humans_detected_description:
                              description: "{{ ai_prompt }}"
                              required: true
                              selector:
                                text: null
                        response_variable: humans_detected_report_record
                      - variables:
                          ai_messages_record: >
                            ü§ñ {{camera_name}}{{'\n'}}üëâ {{ humans_detected_report_record.data.humans_detected_description }} {{'\n'}}üïí {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                      - if:
                          - condition: template
                            value_template: >
                              {{ not ( (humans_detected_report_record.data.humans_detected_description | default(''))| lower | regex_search('tuy nhi√™n kh√¥ng c√≥ ng∆∞·ªùi trong chu·ªói ·∫£nh|kh√¥ng c√≥ ng∆∞·ªùi|kh√¥ng c√≥ chu·ªói h√¨nh ·∫£nh n√†o ƒë∆∞·ª£c cung c·∫•p') and (humans_detected_report_record.data.humans_detected|int(0) == 0) ) }}
                        then:
                          - alias: "Ch·∫°y c√πng l√∫c t·∫•t c·∫£ c√°c action"
                            parallel:
                              - if:
                                  - condition: template
                                    value_template: "{{ include_zalo_notify == 'enable_zalo_notification' and zalo_video }}"
                                then:
                                  - action: zalo_bot.send_video
                                    metadata: {}
                                    data:
                                      message: >
                                        {{ ai_messages_record }}
                                      ttl: !input zalo_ttl
                                      type: !input zalo_types
                                      video_path_or_url: /media/snapshots/{{camera_path}}_recording.mp4
                                      thumbnail_url: snapshot_access_file_path
                                      account_selection: !input zalo_phone
                                      thread_id: !input zalo_group_id
                                      width: 1280
                                      height: 720
                              - if:
                                  - condition: template
                                    value_template: "{{ include_telegram_notify == 'enable_telegram_notification' and tele_video }}"
                                then:
                                  - action: telegram_bot.send_video
                                    metadata: {}
                                    data:
                                      config_entry_id: "{{  provider }}"
                                      authentication: digest
                                      file: /media/snapshots/{{camera_path}}_recording.mp4
                                      target: "{{ telegram_group_id }}"
                                      caption: >
                                        {{ ai_messages_record }}
                                      message_thread_id: "{{ telegram_topic | int(0) }}"
                              - if:
                                  - condition: template
                                    value_template: "{{ include_discord_notify == 'enable_discord_notification' and discord_video }}"
                                then:
                                  - action: notify.hass_discord
                                    metadata: {}
                                    data:
                                      target: "{{discord_channel | int(0)}}"
                                      data:
                                        images:
                                          - /media/snapshots/{{camera_path}}_recording.mp4
                                      message: >
                                        {{ ai_messages_record }}

                  - alias: "Check if AI is disable"
                    conditions:
                      - "{{ ai_powered == 'disable_actions_ai_powered_notify' }}"
                    sequence:
                      - variables:
                          ai_disable_messages_record: >
                            üîç Ph√°t hi·ªán chuy·ªÉn ƒë·ªông t·∫°i {{camera_name}}{{'\n'}}üïí {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                      - alias: "Ch·∫°y c√πng l√∫c t·∫•t c·∫£ c√°c action"
                        parallel:
                          - if:
                              - condition: template
                                value_template: "{{ include_zalo_notify == 'enable_zalo_notification' and zalo_video }}"
                            then:
                              - action: zalo_bot.send_video
                                metadata: {}
                                data:
                                  message: "{{ ai_disable_messages_record }}"
                                  ttl: !input zalo_ttl
                                  type: !input zalo_types
                                  video_path_or_url: /media/snapshots/{{camera_path}}_recording.mp4
                                  thumbnail_url: snapshot_access_file_path
                                  account_selection: !input zalo_phone
                                  thread_id: !input zalo_group_id
                                  width: 1280
                                  height: 720
                          - if:
                              - condition: template
                                value_template: "{{ include_telegram_notify == 'enable_telegram_notification' and tele_video }}"
                            then:
                              - action: telegram_bot.send_video
                                metadata: {}
                                data:
                                  config_entry_id: "{{ provider }}"
                                  authentication: digest
                                  file: /media/snapshots/{{camera_path}}_recording.mp4
                                  target: "{{ telegram_group_id }}"
                                  caption: "{{ ai_disable_messages_record }}"
                                  message_thread_id: "{{ telegram_topic | int(0) }}"
                          - if:
                              - condition: template
                                value_template: "{{ include_discord_notify == 'enable_discord_notification' and discord_video }}"
                            then:
                              - action: notify.hass_discord
                                metadata: {}
                                data:
                                  target: "{{discord_channel | int(0)}}"
                                  data:
                                    images:
                                      - /media/snapshots/{{camera_path}}_recording.mp4
                                  message: "{{ ai_disable_messages_record }}"

  - choose:
      - alias: "Perform the custom action"
        conditions:
          - condition: template
            value_template: "{{ 'enable_custom_actions' in include_custom_actions }}"
        sequence: !input custom_actions

  - delay:
      seconds: "{{ num_delay_actions }}"

mode: restart
max_exceeded: silent
