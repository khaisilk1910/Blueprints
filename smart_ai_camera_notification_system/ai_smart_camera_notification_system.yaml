blueprint:
  name: AI Smart Camera Notification System
  description: >
    ### ğŸ“¢ Chá»¥p áº£nh, PhÃ¢n tÃ­ch áº£nh báº±ng AI vÃ  gá»­i ThÃ´ng bÃ¡o lÃªn Ä‘iá»‡n thoáº¡i, zalo, telegram, Discord vÃ  ra loa náº¿u Cáº£m biáº¿n kÃ­ch hoáº¡t vÃ  thá»±c táº¿ cÃ³ ngÆ°á»i xuáº¥t hiá»‡n trong áº£nh.

    <details>
    <summary><b>Chi tiáº¿t:</b> - Nháº¥n Ä‘á»ƒ má»Ÿ rá»™ng</summary>

      **PhiÃªn báº£n: v.2025.10.20**

        - Chuyá»ƒn sang dÃ¹ng AI-Task

        - Bá» lÆ°u áº£nh vÃ o thÆ° má»¥c `www` chá»‰ lÆ°u vÃ o `Media`

      ***Tham kháº£o link dÆ°á»›i Ä‘á»ƒ thÃªm code vÃ o trong configuration.yaml***

        - https://www.home-assistant.io/integrations/media_source/
        

      **TÃ¡c giáº£: Khaisilk1910 - Nguyá»…n Tiáº¿n Kháº£i**

        1- **CÃ¡c cáº£m biáº¿n dÃ¹ng trong Blueprints: `Motion`(Chuyá»ƒn Ä‘á»™ng), `Presences`(Hiá»‡n diá»‡n), `Door`(Cá»­a)**

        2- **ThÃ´ng bÃ¡o phÃ¢n tÃ­ch hÃ¬nh áº£nh báº±ng AI lÃªn á»©ng dá»¥ng Home Assistant, Zalo, Telegram, Discord vÃ  TTS ra Loa Ä‘Æ°á»£c tÃ­ch há»£p vÃ o Home Assistant ğŸ’¬ğŸ”‰**
        
        3- **Actions Settings: Náº¿u gá»­i thÃ´ng bÃ¡o lÃªn Hass sáº½ cÃ³ thÃªm tÃ¹y chá»n Actions trÃªn thÃ´ng bÃ¡o Ä‘á»ƒ thá»±c hiá»‡n Actions ngay trÃªn thÃ´ng bÃ¡o Hass.**
        
        4- **Chá»‰ thÃ´ng bÃ¡o khi phÃ¡t hiá»‡n `CÃ³ NgÆ°á»i` trong áº£nh**: do sá»­ dá»¥ng AI phÃ¢n tÃ­ch vÃ  káº¿t há»£p Ä‘iá»u kiá»‡n Ä‘á»ƒ loáº¡i bá» thÃ´ng bÃ¡o áº£o tá»« sensor khi thá»±c táº¿ khÃ´ng cÃ³ ngÆ°á»i trong khung hÃ¬nh.

        5- **CÃ³ thá»ƒ tÃ¹y chá»n gá»­i thÃ´ng bÃ¡o lÃªn nhiá»u Äiá»‡n thoáº¡i, Telegram vÃ  lÃªn nhiá»u Loa Ä‘Æ°á»£c tÃ­nh há»£p trong Home Assistant.**
        
        6- **CÃ³ thá»ƒ thÃªm nhiá»u HÃ nh Ä‘á»™ng tÃ¹y chá»n náº¿u muá»‘n thá»±c hiá»‡n.**
        
        7- **CÃ³ thá»ƒ thÃªm nhiá»u Äiá»u kiá»‡n Ä‘á»ƒ cháº¡y Automation**
    </details>      

  domain: automation
  input:

    motion_sensor:
      name: Trigger sensor
      description: Chá»n cáº£m biáº¿n Ä‘á»ƒ kÃ­ch hoáº¡t chá»¥p áº£nh.
      selector:
        entity:
          domain: binary_sensor
          device_class:
            - motion
            - occupancy
            - door

    camera_device:
      name: Camera
      description: Camera mÃ  báº¡n muá»‘n chá»¥p áº£nh
      selector:
        entity:
          domain: camera

    ai_powered:
      name: AI-powered (Optional)
      description: >
        Sá»­ dá»¥ng AI Ä‘á»ƒ phÃ¢n tÃ­ch áº£nh vÃ  Ä‘Æ°a ná»™i dung phÃ¢n tÃ­ch áº£nh vÃ o thÃ´ng bÃ¡o.
        Náº¿u sá»­ dá»¥ng AI phÃ¢n tÃ­ch sáº½ bá»‹ trá»… thÃ´ng bÃ¡o vÃ i giÃ¢y so vá»›i áº£nh chá»¥p. VÃ¬ pháº£i chá» thá»i gian AI phÃ¢n tÃ­ch áº£nh xem cÃ³ ngÆ°á»i má»›i gá»­i thÃ´ng bÃ¡o.
        Náº¿u khÃ´ng sá»­ dá»¥ng AI sáº½ hay bá»‹ gá»­i thÃ´ng bÃ¡o áº£o khi khÃ´ng cÃ³ ngÆ°á»i trong áº£nh do sensor phÃ¡t hiá»‡n nháº§m cÃ³ chuyá»ƒn Ä‘á»™ng do mÃ´i trÆ°á»ng, Ä‘á»™ng váº­t.
      default: enable_actions_ai_powered_notify
      selector:
        select:
          options:
            - label: Enable AI-powered Options
              value: "enable_actions_ai_powered_notify"
            - label: Disable AI-powered Options
              value: "disable_actions_ai_powered_notify"

    ai_provider:
      name: Provider of AI
      description: >
        Chá»n AI sá»§ dá»¥ng cho viá»‡c phÃ¢n tÃ­ch áº£nh.
        Náº¿u khÃ´ng Báº­t sá»­ dá»¥ng AI bÃªn trÃªn khÃ´ng cáº§n chá»n
      selector:
        config_entry:
          integration: google_generative_ai_conversation
      default: []

    record_video:
      name: Recording (Optional)
      description: >
        TÃ¹y chá»n ghi video Ä‘á»ƒ gá»­i khi cÃ³ phÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng.
        Máº·c Ä‘á»‹nh ghi video 10s. VÃ¬ váº­y thÃ´ng bÃ¡o video sáº½ trá»… hÆ¡n.
        Gá»­i video lÃªn cÃ¡c ná»n táº£ng nháº¯n tin Zalo, Telegram, Discord.
      default: disable_recording_options
      selector:
        select:
          options:
            - label: Enable Recording Options
              value: "enable_recording_options"
            - label: Disable Recording Options
              value: "disable_recording_options"

    device_notify_settings:
      name: "Mobile App Notify"
      icon: mdi:devices
      collapsed: true
      input:
        include_notify:
          name: Use The Mobile App Notify Option (Optional)
          description: >
            Enable náº¿u muá»‘n gá»­i thÃ´ng bÃ¡o lÃªn Ä‘iá»‡n thoáº¡i Ä‘Ã£ chá»n bÃªn dÆ°á»›i. Xem thÃªm táº¡i https://companion.home-assistant.io/docs/notifications/notifications-basic
          default: disable_mobile_app_notify
          selector:
            select:
              options:
                - label: Enable Mobile App Notify Options
                  value: "enable_mobile_app_notify"
                - label: Disable Mobile App Notify Options
                  value: "disable_mobile_app_notify"

        is_ios_android:
          name: Is it an Android or iOS device?
          description: >
            Chá»n Ä‘iá»‡n thoáº¡i Ä‘áº©y thÃ´ng bÃ¡o lÃ  Android hay iOS?
          default: android_device
          selector:
            select:
              options:
                - label: Android
                  value: "android_device"
                - label: iOS
                  value: "ios_device"
        notify_device:
          name: Devices Notified
          description: >
            Chá»n Äiá»‡n thoáº¡i muá»‘n thÃ´ng báº£o Ä‘áº©y lÃªn.
          default: []
          selector:
            device:
              filter:
                - integration: mobile_app
              multiple: true
        notify_title:
          name: Title
          description: >
            Nháº­p Title cá»§a ThÃ´ng bÃ¡o.
            CÃ³ tháº» dÃ¹ng CSS HTML Ä‘á»ƒ thiáº¿t láº­p mÃ u sáº¯c, In Ä‘áº­m,... cho ná»™i dung
          default: >
            ğŸ“¢ <b><span style="color: red">{{camera_name}}</span></b><i> cÃ³ chuyá»ƒn Ä‘á»™ng</i>
          selector:
            text:
        tap_navigate:
          name: Tap Navigate
          description: >
            Má»Ÿ Home Assistant vÃ  Ä‘i Ä‘áº¿n vá»‹ trÃ­ bÃªn dÆ°á»›i khi ThÃ´ng bÃ¡o Ä‘Æ°á»£c má»Ÿ.(VÃ­ dá»¥: /lovelace/cameras).
          default: /lovelace/camera
          selector:
            text:
              multiline: false
              multiple: false
        status_bar_icon:
          name: "ğŸŒ  Status Bar Icon"
          description: >
            `DÃ nh cho` `Android`
            Thiáº¿t láº­p icon cho thÃ´ng bÃ¡o trÃªn Status Bar Ä‘iá»‡n thoáº¡i
            TÃ¬m icon táº¡i https://pictogrammers.com/library/mdi/
          default: mdi:motion-sensor
          selector:
            icon:
              placeholder: mdi:motion-sensor
        notification_color:
          name: "ğŸ¨ Notification Color"
          description: >
            `DÃ nh cho` `Android`
            Thiáº¿t láº­p mÃ u cho icon thÃ´ng bÃ¡o trÃªn Status Bar Ä‘iá»‡n thoáº¡i
          default: [255, 0, 0]
          selector:
            color_rgb:

    actions_settings:
      name: "Actions Settings"
      icon: mdi:gesture-double-tap
      collapsed: true
      input:
        include_actions:
          name: Use Actions For Mobile App Notify Option (Optional)
          description: >
            Enable náº¿u muá»‘n cÃ³ Actions trong thÃ´ng bÃ¡o lÃªn Ä‘iá»‡n thoáº¡i Ä‘Ã£ chá»n. Xem thÃªm táº¡i https://companion.home-assistant.io/docs/notifications/actionable-notifications
          default: disable_actions_mobile_app_notify
          selector:
            select:
              options:
                - label: Enable Actions Options
                  value: "enable_actions_mobile_app_notify"
                - label: Disable Actions Options
                  value: "disable_actions_mobile_app_notify"
        confirm_text:
          name: "Confirmation Text"
          description: "Text to show on the confirmation button"
          default: "âœ… Confirm"
          selector:
            text:
        confirm_action:
          name: "Confirmation Action"
          description: "Action to run when notification is confirmed"
          default: []
          selector:
            action:
        dismiss_text:
          name: "Dismiss Text"
          description: "Text to show on the dismiss button"
          default: "âŒ Dismiss"
          selector:
            text:
        enable_custom_dismiss_action:
          name: "Enable Custom Dismiss Action"
          description: "Display notification on Android Auto interface."
          default: false
          selector:
            boolean: {}
        custom_dismiss_action:
          name: "Custom Dismiss Action"
          description: "Action to run when notification is dismissed"
          default: []
          selector:
            action:
        tag:
          name: "\U0001F516â€ƒTag"
          description: "Used to uniquely identify the notification.  \n\nUse tag if you
            are using this script with other notification services.  \nLeave empty otherwise.
            \ \n\nExample: `my_awesome_notification_for_device_X`  \n\n\U0001F44D\U0001F3FBâ€ƒRecommended
            to leave empty\n\n`Optional`"
          default: "dimiss_notifications_now"
          selector:
            text: {}
        timeout:
          name: âŒ›ï¸â€ƒTimeout Duration
          description: "Amount of time to wait for an action response before firing timeout action.  \n\n\U0001F44D\U0001F3FBâ€ƒRecommended: â‰¥1 minute, to allow notifications to be sent.  \nDefault: 10 minutes. \n"
          default:
            hours: 0
            minutes: 10
            seconds: 0
          selector:
            duration:
              enable_day: false


    zalo_settings:
      name: "Zalo Notifications Settings"
      icon: mdi:message-image-outline
      collapsed: true
      input:
        include_zalo_notify:
          name: Use Zalo Notifications Option (Optional)
          description: >
            Enable náº¿u muá»‘n gá»­i thÃ´ng bÃ¡o lÃªn Zalo. Xem thÃªm táº¡i https://github.com/smarthomeblack/zalo_bot
          default: disable_zalo_notification
          selector:
            select:
              options:
                - label: Enable Zalo Notifications
                  value: "enable_zalo_notification"
                - label: Disable Zalo Notifications
                  value: "disable_zalo_notification"

        zalo_group_id:
          name: Zalo Group ID
          description: ID cá»§a user hoáº·c nhÃ³m Zalo (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng dÃ¹ng).
          selector:
            text:
          default: ""

        zalo_phone:
          name: Zalo Acc
          description: Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a Zalo Bot (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng dÃ¹ng).
          selector:
            text:
          default: "+84000000000"

        zalo_types:
          name: Use Zalo Type Option (Optional)
          description: >
            Chá»n thÃ´ng bÃ¡o lÃªn Zalo cÃ¡ nhÃ¢n hoáº·c group. Xem thÃªm táº¡i https://github.com/smarthomeblack/zalo_bot
          default: "0"
          selector:
            select:
              options:
                - label: User
                  value: "0"
                - label: Group
                  value: "1"
        zalo_ttl:
          name: TTL
          description: Thá»i gian chá» sau thá»i gian nÃ y tin nháº¯n sáº½ tá»± xÃ³a.
          selector:
            number:
              min: 0
              max: 86400000
              step: 1000
              unit_of_measurement: seconds
          default: 0

    telegram_settings:
      name: "Telegram Notifications Settings"
      icon: mdi:message-badge
      collapsed: true
      input:
        include_telegram_notify:
          name: Use Telegram Notifications Option (Optional)
          description: >
            Enable náº¿u muá»‘n gá»­i thÃ´ng bÃ¡o lÃªn Telegram. Xem thÃªm táº¡i https://www.home-assistant.io/integrations/?search=telegram
          default: disable_telegram_notification
          selector:
            select:
              options:
                - label: Enable Telegram Notifications
                  value: "enable_telegram_notification"
                - label: Disable Telegram Notifications
                  value: "disable_telegram_notification"
     
        provider:
          name: Config entry ID
          description: Choose Telegram Bot to use for send Notifications.
          selector:
            config_entry:
              integration: telegram_bot
          default: []

        telegram_group_id:
          name: Telegram Group ID
          description: ID cá»§a nhÃ³m Telegram (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng dÃ¹ng).
          selector:
            text:
          default: ""

        telegram_topic:
          name: Telegram Topic ID
          description: ID cá»§a chá»§ Ä‘á» trong nhÃ³m Telegram (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng dÃ¹ng).
          selector:
            text:
          default: ""

    discord_settings:
      name: "Discord Notifications Settings"
      icon: mdi:message-bulleted
      collapsed: true
      input:
        include_discord_notify:
          name: Use Discord Notifications Option (Optional)
          description: >
            Enable náº¿u muá»‘n gá»­i thÃ´ng bÃ¡o lÃªn Discord. Xem thÃªm táº¡i https://www.home-assistant.io/integrations/discord/
          default: disable_discord_notification
          selector:
            select:
              options:
                - label: Enable Discord Notifications
                  value: "enable_discord_notification"
                - label: Disable Discord Notifications
                  value: "disable_discord_notification"
        discord_channel:
          name: Discord Channel ID
          description: ID cá»§a Channel trong nhÃ³m Discord (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng dÃ¹ng).
          selector:
            text:
          default: ""

    tts_notify_settings:
      name: "Speakers Settings"
      icon: mdi:speaker-message
      collapsed: true
      input:
        include_tts_announcement:
          name: Use The Text-to-Speech Announcement Option (Optional)
          description: >
            Enable khi muá»‘n gá»­i TTS ra loa sáº½ chá»n bÃªn dÆ°á»›i. Xem thÃªm táº¡i https://www.home-assistant.io/integrations/?search=tts
          default: disable_tts_announcement
          selector:
            select:
              options:
                - label: Enable Text-to-Speech Announcements
                  value: "enable_tts_announcement"
                - label: Disable Text-to-Speech Announcements
                  value: "disable_tts_announcement"
        num_volume_speaker:
          name: Volume Set
          description: Thiáº¿t láº­p Ã‚m lÆ°á»£ng cho Loa. ( tá»« 0.1 Ä‘áº¿n 1)
          selector:
            number:
              min: 0.1
              max: 1
              step: 0.1
              #unit_of_measurement: snapshots
          default: 1
        text_to_speech_engine:
          name: Text-to-Speech Service Provider
          description: >
            Chá»n dá»‹ch vá»¥ TTS há»— trá»£.
          default: []
          selector:
            entity:
              filter:
                domain: tts
        media_player:
          name: Media Player
          description: >
            Chá»n loa Ä‘á»ƒ phÃ¡t thÃ´ng bÃ¡o
          default: []
          selector:
            entity:
              filter:
                domain: media_player
              multiple: true

    prompt_number_delay_settings:
      name: "Prompt | Number | Delay of Snapshots"
      icon: mdi:clock-start
      collapsed: true
      input:
        num_snapshots:
          name: Number of Snapshots
          description: Sá»‘ áº£nh sáº½ chá»¥p Ä‘á»ƒ so sÃ¡nh (tá»« 1 Ä‘áº¿n 5)
          selector:
            number:
              min: 1
              max: 5
              step: 1
              unit_of_measurement: snapshots
          default: 1
        num_delay:
          name: Delay after Snapshots
          description: Thá»i gian trá»… sau má»—i láº§n Snapshots (tÃ­nh theo giÃ¢y)
          selector:
            number:
              min: 1
              max: 60
              step: 1
              unit_of_measurement: seconds
          default: 1
        num_delay_actions:
          name: Delays
          description: Thá»i gian chá» sau khi hoÃ n thÃ nh táº¥t cáº£ cÃ¡c hÃ nh Ä‘á»™ng (tÃ­nh theo giÃ¢y). Automation nÃ y chá»‰ hoáº¡t Ä‘á»™ng láº¡i sau khi háº¿t thá»i gian Delay nÃ y.
          selector:
            number:
              min: 5
              max: 120
              step: 5
              unit_of_measurement: seconds
          default: 5

        ai_prompt:
          name: AI Prompt
          description: CÃ¢u lá»‡nh cho AI phÃ¢n tÃ­ch.
          selector:
            text:
              multiline: true
          default: >
            DÃ¹ng ngÃ´n ngá»¯ Viá»‡t Nam. HÃ£y so sÃ¡nh vÃ  mÃ´ táº£ ráº¥t ngáº¯n gá»n nhá»¯ng gÃ¬ báº¡n tháº¥y trong chuá»—i hÃ¬nh áº£nh
            sau tá»« mÃ¡y áº£nh {{ camera_name }} cá»§a tÃ´i. Náº¿u cÃ³ ngÆ°á»i, Ä‘á»™ng váº­t, xe mÃ¡y
            hoáº·c Ã´ tÃ´, hÃ£y mÃ´ táº£ chi tiáº¿t vá» chÃºng. KhÃ´ng mÃ´ táº£ cÃ¡c váº­t thá»ƒ hoáº·c tÃ²a
            nhÃ  cá»‘ Ä‘á»‹nh. Náº¿u trong chuá»—i áº£nh khÃ´ng cÃ³ ngÆ°á»i hÃ£y tráº£ lá»i "ÄÃ£ phÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng tuy nhiÃªn khÃ´ng cÃ³ ngÆ°á»i trong chuá»—i áº£nh khi so sÃ¡nh". Tin nháº¯n cá»§a báº¡n cáº§n Ä‘á»§ ngáº¯n Ä‘á»ƒ cÃ³ thá»ƒ Ä‘Æ°a vÃ o thÃ´ng bÃ¡o trÃªn Ä‘iá»‡n thoáº¡i.

    custom_actions_settings:
      name: "Custom Actions"
      icon: mdi:gesture-tap-button
      collapsed: true
      input:
        include_custom_actions:
          name: Use The Custom Action Options (Optional)
          description: >
            Chá»n Enable Custom Actions vÃ  thÃªm Actions bÃªn dÆ°á»›i náº¿u báº¡n muá»‘n thÃªm cÃ¡c HÃ nh Ä‘á»™ng khÃ¡c Ä‘á»ƒ thá»±c hiá»‡n trong Automation nÃ y.
          default: disable_custom_actions
          selector:
            select:
              options:
                - label: Enable Custom Actions
                  value: "enable_custom_actions"
                - label: Disable Custom Actions
                  value: "disable_custom_actions"
        custom_actions:
          name: Custom Actions
          description: >
            ThÃªm báº¥t ká»³ hÃ nh Ä‘á»™ng nÃ o báº¡n muá»‘n cháº¡y trong Automation nÃ y.
            Biáº¿n láº¥y ná»™i dung phÃ¢n tÃ­ch AI cho cÃ¡c ná»™i dung khÃ¡c: `humans_detected_report.data.humans_detected_description`
          default: []
          selector:
            action:

    global_conditions_settings:
      name: "Global Conditions"
      icon: mdi:earth
      collapsed: true
      input:
        global_conditions:
          name: Add Condition(s) to run this Automation
          description: >
            ThÃªm Condition Ä‘á»ƒ cháº¡y Automation. Automation chá»‰ cháº¡y khi Conditions nÃ y lÃ  True.
          default: []
          selector:
            condition:

trigger:
  platform: state
  entity_id: !input motion_sensor
  to: "on"

variables:
  record_video: !input record_video
  #AI
  ai_powered: !input ai_powered
  ai_provider: !input ai_provider
  #Device Notify
  include_notify: !input include_notify
  notify_device: !input notify_device
  notify_title: !input notify_title
  tap_navigate: !input tap_navigate
  filtered_devices: >
    {{ notify_device }}
  is_ios_android: !input "is_ios_android"
  #Actions Settings
  include_actions: !input include_actions
  confirm_text: !input confirm_text
  dismiss_text: !input dismiss_text
  timeout: !input timeout
  enable_custom_dismiss_action: !input enable_custom_dismiss_action
  tag: !input tag
  #Zalo Message
  include_zalo_notify: !input include_zalo_notify
  #Camera
  camera_device: !input camera_device
  camera_name: "{{ state_attr(camera_device, 'friendly_name') }}"
  camera_path: "{{ state_attr(camera_device, 'friendly_name') | slugify }}"
  #camera_path: "{{ state_attr(camera_device, 'friendly_name') | lower | replace(' ', '_') }}"
  #Motion Sensor
  motion_sensor: !input motion_sensor
  motion_name: "{{ state_attr(motion_sensor, 'friendly_name') }}"
  #Snapshot
  num_delay_actions: !input num_delay_actions
  num_snapshots: !input num_snapshots
  num_delay: !input num_delay
  #AI
  ai_prompt: !input ai_prompt
  #Telegram Message
  include_telegram_notify: !input include_telegram_notify
  provider: !input provider
  telegram_group_id: !input telegram_group_id
  telegram_topic: !input telegram_topic
  #Discord
  include_discord_notify: !input include_discord_notify
  discord_channel: !input discord_channel
  #TTS Message
  include_tts_announcement: !input include_tts_announcement
  num_volume_speaker: !input num_volume_speaker
  text_to_speech_engine: !input text_to_speech_engine
  media_player: !input media_player
  #Custom Actions
  include_custom_actions: !input include_custom_actions
  custom_actions: !input custom_actions
  #Global Conditions
  global_conditions: !input global_conditions

# All Conditions
condition:
  # Global Conditions
  - condition: and
    conditions: !input global_conditions

action:
  - variables:
      action_confirm: "{{ 'CONFIRM_' ~ context.id }}"
      action_dismiss: "{{ 'DISMISS_' ~ context.id }}"
      snapshot_access_file_path: "/media/local/snapshots/{{camera_path}}_snapshot1.jpg"
      snapshot_access_file_path_tele: "/media/snapshots/{{camera_path}}_snapshot1.jpg"
      snapshot_access_file_path_discord: "/media/snapshots/{{camera_path}}_snapshot1.jpg"
      notification_color: !input "notification_color"
      notification_color_hex: "#{{ '%02x%02x%02x' | format(notification_color[0], notification_color[1], notification_color[2]) }}"


  - alias: "Cháº¡y cÃ¹ng lÃºc táº¥t cáº£ cÃ¡c action"
    parallel:

      - alias: "Cháº¡y láº§n lÆ°á»£t cÃ¡c action"
        sequence:
          - repeat:
              count: "{{ num_snapshots }}"
              sequence:
                - action: camera.snapshot
                  data:
                    filename: "/media/snapshots/{{ camera_path }}_snapshot{{ repeat.index }}.jpg"
                  target:
                    entity_id: "{{ camera_device }}"
                - delay:
                    seconds: "{{ num_delay }}"

          - variables:
              snapshots_url: >
                {% set snap_count = num_snapshots | int %}
                {% set camera = camera_path %}
                {% set ns = namespace(images=[]) %}
                {%- for i in range(1, snap_count + 1) -%}
                  {% set ns.images = ns.images + [{'media_content_id': 'media-source://media_source/local/snapshots/' ~ camera ~ '_snapshot' ~ i ~ '.jpg', 'media_content_type': 'image/jpeg'}] %}
                {%- endfor -%}
                {{ ns.images }}

          - choose:
              - alias: "Check if notification is enabled"
                conditions:
                  - "{{ ai_powered == 'enable_actions_ai_powered_notify' }}"
                sequence:
                  - action: ai_task.generate_data
                    data:
                      task_name: Phan tich anh khi co chuyen dong
                      instructions: >
                        ÄÃ¢y lÃ  chuá»—i hÃ¬nh áº£nh tá»« mÃ¡y áº£nh {{camera_name}} cá»§a tÃ´i. CÃ³ bao nhiÃªu ngÆ°á»i trong chuá»—i áº£nh cá»§a tÃ´i?
                      #entity_id: "{{ ai_provider }}"
                      attachments: "{{ snapshots_url }}"
                      structure:
                        humans_detected:
                          required: true
                          selector:
                            number: null
                        humans_detected_description:
                          description: "{{ ai_prompt }}"
                          required: true
                          selector:
                            text: null
                    response_variable: humans_detected_report

                  - variables:
                      ai_messages: >
                        {{ humans_detected_report.data.humans_detected_description }} {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}

                  - if:
                      - condition: template
                        value_template: >
                          {{ not ( (humans_detected_report.data.humans_detected_description | default(''))| lower | regex_search('tuy nhiÃªn khÃ´ng cÃ³ ngÆ°á»i trong chuá»—i áº£nh|khÃ´ng cÃ³ ngÆ°á»i|khÃ´ng cÃ³ chuá»—i hÃ¬nh áº£nh nÃ o Ä‘Æ°á»£c cung cáº¥p') and (humans_detected_report.data.humans_detected|int(0) == 0) ) }}
                    then:
                      - alias: "Cháº¡y cÃ¹ng lÃºc táº¥t cáº£ cÃ¡c Action"
                        parallel:
                          - choose:
                              - alias: "Check if notification is enabled"
                                conditions:
                                  - "{{ include_notify == 'enable_mobile_app_notify' }}"
                                  - "{{ filtered_devices | length > 0 }}"
                                sequence:
                                  - if:
                                      - condition: template
                                        value_template: "{{ include_actions == 'enable_actions_mobile_app_notify' }}"
                                    then:
                                      - choose:
                                          - alias: "Check if Android"
                                            conditions:
                                              - "{{ is_ios_android == 'android_device' }}"
                                            sequence:
                                              - alias: Send a notification to each device
                                                repeat:
                                                  for_each: "{{ filtered_devices }}"
                                                  sequence:
                                                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                      data:
                                                        title: !input notify_title
                                                        message: "{{ ai_messages }}"
                                                        data:
                                                          priority: high
                                                          notification_icon: !input status_bar_icon
                                                          color: "{{ notification_color_hex }}"
                                                          image: "{{snapshot_access_file_path}}"
                                                          url: "{{tap_navigate}}"
                                                          clickAction: "{{tap_navigate}}"
                                                          tag: "{{ tag }}"
                                                          actions:
                                                            - action: "{{ action_confirm }}"
                                                              title: "{{ confirm_text }}"
                                                            - action: "{{ action_dismiss }}"
                                                              title: "{{ dismiss_text }}"
                                          - alias: "Check if iOS"
                                            conditions:
                                              - "{{ is_ios_android == 'ios_device' }}"
                                            sequence:
                                              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                data:
                                                  title: !input notify_title
                                                  message: >
                                                    {{ ai_messages }}
                                                  data:
                                                    attachment:
                                                      url: "{{snapshot_access_file_path}}"
                                                      content_type: "JPEG"
                                                    tag: "{{ tag }}"
                                                    actions:
                                                      - action: "{{ action_confirm }}"
                                                        title: "{{ confirm_text }}"
                                                      - action: "{{ action_dismiss }}"
                                                        title: "{{ dismiss_text }}"
                                      - alias: "Awaiting response"
                                        wait_for_trigger:
                                          - platform: event
                                            event_type: mobile_app_notification_action
                                            event_data:
                                              action: "{{ action_confirm }}"
                                          - platform: event
                                            event_type: mobile_app_notification_action
                                            event_data:
                                              action: "{{ action_dismiss }}"
                                        timeout: '{{ timeout }}'
                                        continue_on_timeout: true
                                      - choose:
                                          - conditions: "{{ wait.trigger.event.data.action == action_confirm }}"
                                            sequence: !input confirm_action
                                          - conditions: "{{ wait.trigger.event.data.action == action_dismiss }}"
                                            sequence:
                                              - alias: Náº¿u Enable Custom Dismiss Action Ä‘Æ°á»£c Báº­t thÃ¬ sáº½ hÃ nh Ä‘á»™ng theo Custom Dismiss Action. CÃ²n khÃ´ng thÃ¬ sáº½ xÃ³a ThÃ´ng bÃ¡o.
                                                if:
                                                  - condition: template
                                                    value_template: "{{ not enable_custom_dismiss_action}}"
                                                then:
                                                  - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                    data:
                                                      message: "clear_notification"
                                                      data:
                                                        tag: "{{ tag }}"
                                                else: !input custom_dismiss_action
                                    else:
                                      - choose:
                                          - alias: "Check if Android"
                                            conditions:
                                              - "{{ is_ios_android == 'android_device' }}"
                                            sequence:
                                              - alias: Send a notification to each device
                                                repeat:
                                                  for_each: "{{ filtered_devices }}"
                                                  sequence:
                                                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                      data:
                                                        title: !input notify_title
                                                        message: "{{ ai_messages }}"
                                                        data:
                                                          priority: high
                                                          notification_icon: !input status_bar_icon
                                                          color: "{{ notification_color_hex }}"
                                                          image: "{{snapshot_access_file_path}}"
                                                          url: "{{tap_navigate}}"
                                                          clickAction: "{{tap_navigate}}"
                                          - alias: "Check if iOS"
                                            conditions:
                                              - "{{ is_ios_android == 'ios_device' }}"
                                            sequence:
                                              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                data:
                                                  title: !input notify_title
                                                  message: >
                                                    {{ ai_messages }}
                                                  data:
                                                    attachment:
                                                      url: "{{snapshot_access_file_path}}"
                                                      content_type: "JPEG"

                          - if:
                              - condition: template
                                value_template: "{{ include_zalo_notify == 'enable_zalo_notification' }}"
                            then:
                              - action: zalo_bot.send_image
                                metadata: {}
                                data:
                                  type: !input zalo_types
                                  image_path: "{{ snapshot_access_file_path_tele }}"
                                  message: >
                                    ğŸ¤–ğŸ‘‰ {{ ai_messages }}
                                  thread_id: !input zalo_group_id
                                  account_selection: !input zalo_phone
                                  ttl: !input zalo_ttl

                          - if:
                              - condition: template
                                value_template: "{{ include_telegram_notify == 'enable_telegram_notification' }}"
                            then:
                              - action: telegram_bot.send_photo
                                data:
                                  config_entry_id: "{{ provider }}"
                                  authentication: digest
                                  target: "{{ telegram_group_id }}"
                                  message_thread_id: "{{ telegram_topic | int(0) }}"
                                  file: "{{ snapshot_access_file_path_tele }}"
                                  caption: >
                                    ğŸ¤–ğŸ‘‰ {{ ai_messages }}

                          - if:
                              - condition: template
                                value_template: "{{ include_discord_notify == 'enable_discord_notification' }}"
                            then:
                              - action: notify.hass_discord
                                metadata: {}
                                data:
                                  target: "{{discord_channel | int(0)}}"
                                  data:
                                    images:
                                      - "{{snapshot_access_file_path_discord}}"
                                  title: "{{camera_name}}"
                                  message: >
                                    ğŸ¤–ğŸ‘‰ {{ ai_messages }}

                          - if:
                              - condition: template
                                value_template: "{{ include_tts_announcement == 'enable_tts_announcement' }}"
                            then:
                              - action: media_player.volume_set
                                metadata: {}
                                data:
                                  volume_level: "{{num_volume_speaker}}"
                                target:
                                  entity_id: !input media_player
                              - action: tts.speak
                                target:
                                  entity_id: !input text_to_speech_engine
                                data:
                                  media_player_entity_id: !input media_player
                                  message: "{{humans_detected_report.data.humans_detected_description}}"

              - alias: "Check if AI is disable"
                conditions:
                  - "{{ ai_powered == 'disable_actions_ai_powered_notify' }}"
                sequence:
                  - alias: "Cháº¡y cÃ¹ng lÃºc táº¥t cáº£ cÃ¡c Choose"
                    parallel:
                      - choose:
                          - alias: "Check if notification is enabled"
                            conditions:
                              - "{{ include_notify == 'enable_mobile_app_notify' }}"
                              - "{{ filtered_devices | length > 0 }}"
                            sequence:
                              - if:
                                  - condition: template
                                    value_template: "{{ include_actions == 'enable_actions_mobile_app_notify' }}"
                                then:
                                  - choose:
                                      - alias: "Check if Android"
                                        conditions:
                                          - "{{ is_ios_android == 'android_device' }}"
                                        sequence:
                                          - alias: Send a notification to each device
                                            repeat:
                                              for_each: "{{ filtered_devices }}"
                                              sequence:
                                                - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                  data:
                                                    title: !input notify_title
                                                    message: >
                                                      ğŸ” Kiá»ƒm tra ngay
                                                      {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                                                    data:
                                                      priority: high
                                                      notification_icon: !input status_bar_icon
                                                      color: "{{ notification_color_hex }}"
                                                      image: "{{snapshot_access_file_path}}"
                                                      url: "{{tap_navigate}}"
                                                      clickAction: "{{tap_navigate}}"
                                                      tag: "{{ tag }}"
                                                      actions:
                                                        - action: "{{ action_confirm }}"
                                                          title: "{{ confirm_text }}"
                                                        - action: "{{ action_dismiss }}"
                                                          title: "{{ dismiss_text }}"
                                      - alias: "Check if iOS"
                                        conditions:
                                          - "{{ is_ios_android == 'ios_device' }}"
                                        sequence:
                                          - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                            data:
                                              title: !input notify_title
                                              message: >
                                                ğŸ” Kiá»ƒm tra ngay
                                                {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                                              data:
                                                attachment:
                                                  url: "{{snapshot_access_file_path}}"
                                                  content_type: "JPEG"
                                                tag: "{{ tag }}"
                                                actions:
                                                  - action: "{{ action_confirm }}"
                                                    title: "{{ confirm_text }}"
                                                  - action: "{{ action_dismiss }}"
                                                    title: "{{ dismiss_text }}"
                                  - alias: "Awaiting response"
                                    wait_for_trigger:
                                      - platform: event
                                        event_type: mobile_app_notification_action
                                        event_data:
                                          action: "{{ action_confirm }}"
                                      - platform: event
                                        event_type: mobile_app_notification_action
                                        event_data:
                                          action: "{{ action_dismiss }}"
                                    timeout: '{{ timeout }}'
                                    continue_on_timeout: true
                                  - choose:
                                      - conditions: "{{ wait.trigger.event.data.action == action_confirm }}"
                                        sequence: !input confirm_action
                                      - conditions: "{{ wait.trigger.event.data.action == action_dismiss }}"
                                        sequence:
                                          - alias: Náº¿u Enable Custom Dismiss Action Ä‘Æ°á»£c Báº­t thÃ¬ sáº½ hÃ nh Ä‘á»™ng theo Custom Dismiss Action. CÃ²n khÃ´ng thÃ¬ sáº½ xÃ³a ThÃ´ng bÃ¡o.
                                            if:
                                              - condition: template
                                                value_template: "{{ not enable_custom_dismiss_action}}"
                                            then:
                                              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                data:
                                                  message: "clear_notification"
                                                  data:
                                                    tag: "{{ tag }}"
                                            else: !input custom_dismiss_action
                                else:
                                  - choose:
                                      - alias: "Check if Android"
                                        conditions:
                                          - "{{ is_ios_android == 'android_device' }}"
                                        sequence:
                                          - alias: Send a notification to each device
                                            repeat:
                                              for_each: "{{ filtered_devices }}"
                                              sequence:
                                                - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                                  data:
                                                    title: !input notify_title
                                                    message: >
                                                      ğŸ” Kiá»ƒm tra ngay
                                                      {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                                                    data:
                                                      priority: high
                                                      notification_icon: !input status_bar_icon
                                                      color: "{{ notification_color_hex }}"
                                                      image: "{{snapshot_access_file_path}}"
                                                      url: "{{tap_navigate}}"
                                                      clickAction: "{{tap_navigate}}"
                                      - alias: "Check if iOS"
                                        conditions:
                                          - "{{ is_ios_android == 'ios_device' }}"
                                        sequence:
                                          - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                            data:
                                              title: !input notify_title
                                              message: >
                                                ğŸ” Kiá»ƒm tra ngay
                                                {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                                              data:
                                                attachment:
                                                  url: "{{snapshot_access_file_path}}"
                                                  content_type: "JPEG"

                      - if:
                          - condition: template
                            value_template: "{{ include_zalo_notify == 'enable_zalo_notification' }}"
                        then:
                          - action: zalo_bot.send_image
                            metadata: {}
                            data:
                              type: !input zalo_types
                              image_path: "{{ snapshot_access_file_path_tele }}"
                              message: >
                                ğŸ” PhÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng táº¡i {{camera_name}}
                                {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                              thread_id: !input zalo_group_id
                              account_selection: !input zalo_phone
                              ttl: !input zalo_ttl

                      - if:
                          - condition: template
                            value_template: "{{ include_telegram_notify == 'enable_telegram_notification' }}"
                        then:
                          - action: telegram_bot.send_photo
                            data:
                              config_entry_id: "{{ provider }}"
                              authentication: digest
                              target: "{{ telegram_group_id }}"
                              message_thread_id: "{{ telegram_topic | int(0) }}"
                              file: "{{ snapshot_access_file_path_tele }}"
                              caption: >
                                ğŸ” PhÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng táº¡i {{camera_name}}
                                {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}

                      - if:
                          - condition: template
                            value_template: "{{ include_discord_notify == 'enable_discord_notification' }}"
                        then:
                          - action: notify.hass_discord
                            metadata: {}
                            data:
                              target: "{{discord_channel | int(0)}}"
                              data:
                                images:
                                  - "{{snapshot_access_file_path_discord}}"
                              title: "{{camera_name}}"
                              message: >
                                ğŸ” PhÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng
                                {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}


      - if:
          - condition: template
            value_template: "{{ record_video == 'enable_recording_options' }}"
        then:
          - alias: "Cháº¡y láº§n lÆ°á»£t cÃ¡c action"
            sequence:
              - action: camera.record
                metadata: {}
                data:
                  duration: 8
                  lookback: 3
                  filename: /media/snapshots/{{ camera_path }}_recording.mp4
                target:
                  entity_id: "{{ camera_device }}"
              - variables:
                  snapshots_url_record: >
                    {% set camera = camera_path %}
                    {% set ns = [{'media_content_id': 'media-source://media_source/local/snapshots/' ~ camera ~ '_snapshot1.jpg', 'media_content_type': 'image/jpeg'}] %}
                    {{ ns }}
              - delay:
                  hours: 0
                  minutes: 0
                  seconds: 2
                  milliseconds: 0
              - choose:
                  - alias: "Check if AI is enabled"
                    conditions:
                      - "{{ ai_powered == 'enable_actions_ai_powered_notify' }}"
                    sequence:
                      - action: ai_task.generate_data
                        data:
                          task_name: Phan tich anh khi co chuyen dong
                          instructions: >
                            ÄÃ¢y lÃ  hÃ¬nh áº£nh tá»« {{camera_name}} cá»§a tÃ´i. CÃ³ bao nhiÃªu ngÆ°á»i trong áº£nh cá»§a tÃ´i?
                          #entity_id: "{{ ai_provider }}"
                          attachments: "{{ snapshots_url_record }}"
                          structure:
                            humans_detected:
                              required: true
                              selector:
                                number: null
                            humans_detected_description:
                              description: "{{ ai_prompt }}"
                              required: true
                              selector:
                                text: null
                        response_variable: humans_detected_report_record
                      - variables:
                          ai_messages_record: >
                            ğŸ¤–ğŸ‘‰ {{ humans_detected_report_record.data.humans_detected_description }} {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                      - if:
                          - condition: template
                            value_template: >
                              {{ not ( (humans_detected_report_record.data.humans_detected_description | default(''))| lower | regex_search('tuy nhiÃªn khÃ´ng cÃ³ ngÆ°á»i trong chuá»—i áº£nh|khÃ´ng cÃ³ ngÆ°á»i|khÃ´ng cÃ³ chuá»—i hÃ¬nh áº£nh nÃ o Ä‘Æ°á»£c cung cáº¥p') and (humans_detected_report_record.data.humans_detected|int(0) == 0) ) }}
                        then:
                          - alias: "Cháº¡y cÃ¹ng lÃºc táº¥t cáº£ cÃ¡c action"
                            parallel:
                              - if:
                                  - condition: template
                                    value_template: "{{ include_zalo_notify == 'enable_zalo_notification' }}"
                                then:
                                  - action: zalo_bot.send_video
                                    metadata: {}
                                    data:
                                      message: >
                                        {{ ai_messages_record }}
                                      ttl: 0
                                      type: "0"
                                      video_path_or_url: /media/snapshots/{{camera_path}}_recording.mp4
                                      thumbnail_url: snapshot_access_file_path
                                      account_selection: "+84376861184"
                                      thread_id: "2036121378794772276"
                                      width: 1280
                                      height: 720
                              - if:
                                  - condition: template
                                    value_template: "{{ include_telegram_notify == 'enable_telegram_notification' }}"
                                then:
                                  - action: telegram_bot.send_video
                                    metadata: {}
                                    data:
                                      config_entry_id: "{{  provider }}"
                                      authentication: digest
                                      file: /media/snapshots/{{camera_path}}_recording.mp4
                                      target: "{{ telegram_group_id }}"
                                      caption: >
                                        {{ ai_messages_record }}
                                      message_thread_id: "{{ telegram_topic | int(0) }}"
                              - if:
                                  - condition: template
                                    value_template: "{{ include_discord_notify == 'enable_discord_notification' }}"
                                then:
                                  - action: notify.hass_discord
                                    metadata: {}
                                    data:
                                      target: "{{discord_channel | int(0)}}"
                                      data:
                                        images:
                                          - /media/snapshots/{{camera_path}}_recording.mp4
                                      message: >
                                        {{ ai_messages_record }}

                  - alias: "Check if AI is disable"
                    conditions:
                      - "{{ ai_powered == 'disable_actions_ai_powered_notify' }}"
                    sequence:
                      - alias: "Cháº¡y cÃ¹ng lÃºc táº¥t cáº£ cÃ¡c action"
                        parallel:
                          - if:
                              - condition: template
                                value_template: "{{ include_zalo_notify == 'enable_zalo_notification' }}"
                            then:
                              - action: zalo_bot.send_video
                                metadata: {}
                                data:
                                  message: >
                                    ğŸ” PhÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng táº¡i {{camera_name}}
                                    {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                                  ttl: 0
                                  type: "0"
                                  video_path_or_url: /media/snapshots/{{camera_path}}_recording.mp4
                                  thumbnail_url: snapshot_access_file_path
                                  account_selection: "+84376861184"
                                  thread_id: "2036121378794772276"
                                  width: 1280
                                  height: 720
                          - if:
                              - condition: template
                                value_template: "{{ include_telegram_notify == 'enable_telegram_notification' }}"
                            then:
                              - action: telegram_bot.send_video
                                metadata: {}
                                data:
                                  config_entry_id: "{{ provider }}"
                                  authentication: digest
                                  file: /media/snapshots/{{camera_path}}_recording.mp4
                                  target: "{{ telegram_group_id }}"
                                  caption: >
                                    ğŸ” PhÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng táº¡i {{camera_name}}
                                    {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
                                  message_thread_id: "{{ telegram_topic | int(0) }}"
                          - if:
                              - condition: template
                                value_template: "{{ include_discord_notify == 'enable_discord_notification' }}"
                            then:
                              - action: notify.hass_discord
                                metadata: {}
                                data:
                                  target: "{{discord_channel | int(0)}}"
                                  data:
                                    images:
                                      - /media/snapshots/{{camera_path}}_recording.mp4
                                  message: >
                                    ğŸ” PhÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng táº¡i {{camera_name}}
                                    {{'\n'}}ğŸ•’ {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}

  - choose:
      - alias: "Perform the custom action"
        conditions:
          - condition: template
            value_template: "{{ 'enable_custom_actions' in include_custom_actions }}"
        sequence: !input custom_actions

  - delay:
      seconds: "{{ num_delay_actions }}"

mode: restart
max_exceeded: silent
